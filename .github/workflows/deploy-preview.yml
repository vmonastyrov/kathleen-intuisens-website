name: Deploy Preview

on:
  push:
    branches-ignore:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Get branch name
        id: branch
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –≤–µ—Ç–∫–∏ –∏ –æ—á–∏—â–∞–µ–º –æ—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          SAFE_BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9-]/-/g')
          echo "name=$SAFE_BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Deploying preview for branch: $SAFE_BRANCH_NAME"

      - name: Build with preview base path
        run: bun run build
        env:
          VITE_BASE_PATH: /kathleen-intuisens-website/preview/${{ steps.branch.outputs.name }}/

      - name: Deploy to GitHub Pages (Preview)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          destination_dir: preview/${{ steps.branch.outputs.name }}
          keep_files: true
          commit_message: "Deploy preview for ${{ steps.branch.outputs.name }}"

      - name: Comment preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ steps.branch.outputs.name }}';
            const previewUrl = `https://vmonastyrov.github.io/kathleen-intuisens-website/preview/${branchName}/`;

            console.log(`Preview deployed at: ${previewUrl}`);

            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ PR, –µ—Å–ª–∏ —ç—Ç–æ PR
            if (context.payload.pull_request) {
              github.rest.issues.createComment({
                issue_number: context.payload.pull_request.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `üöÄ Preview deployed!\n\n**Preview URL:** ${previewUrl}\n\n*Branch: \`${branchName}\`*`
              });
            }
